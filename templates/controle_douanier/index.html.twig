{% extends 'base.html.twig' %}

{% block title %}📋 Liste des contrôles douaniers{% endblock %}

{% block body %}
    <div class="container-fluid mt-4">
        <!-- Notifications des contrôles en attente -->
        {% if pendingAlerts|length > 0 %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Contrôles en attente nécessitant votre attention</h4>
                <p>Les contrôles suivants sont en attente pour aujourd'hui ou demain :</p>
                <ul>
                    {% for alert in pendingAlerts %}
                        <li>
                            <strong>{{ alert.paysDouane }}</strong> - 
                            {{ alert.dateControle|date('d/m/Y') }} - 
                            <a href="{{ path('app_controle_douanier_edit', {'id_controle': alert.id_controle}) }}" class="alert-link">
                                Modifier
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
        
        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center bg-white">
                        <h2 class="h5 mb-0">📋 Liste des contrôles douaniers</h2>
                        <a href="{{ path('app_controle_douanier_new') }}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus me-1"></i> Nouveau
                        </a>
                    </div>
                    
                    <div class="card-body">
                        <!-- Formulaire de recherche -->
                        {{ include('controle_douanier/_search_form.html.twig') }}
                        
                        <!-- Tableau des contrôles -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <!-- ... Votre tableau existant ... -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Colonne des statistiques -->
            <div class="col-lg-4">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h2 class="h5 mb-0">📊 Statistiques des contrôles</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="statisticsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Graphique des statistiques
            const ctx = document.getElementById('statisticsChart').getContext('2d');
            const statisticsData = {{ statistics|json_encode|raw }};
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statisticsData),
                    datasets: [{
                        data: Object.keys(statisticsData).map(key => statisticsData[key]),
                        backgroundColor: [
                            '#FF6384', // En attente
                            '#36A2EB', // En cours
                            '#4BC0C0', // Validé
                            '#FFCE56'  // Rejeté
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Fermeture automatique des alertes
            const alert = document.querySelector('.alert');
            if (alert) {
                setTimeout(() => {
                    new bootstrap.Alert(alert).close();
                }, 10000);
            }
        });
    </script>
{% endblock %}